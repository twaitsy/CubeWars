CubeWars Civilian Prefab Setup Guide
===================================

Prefab Path
- Assets/Prefabs/Civilian.prefab

Civilian Core Role
- Worker unit for gathering, hauling, building, crafting, survival needs.

Required Components
- Civilian
- NavMeshAgent
- Selectable
- Collider

Recommended Components
- CharacterStats (optional stat override support)
- TeamVisual (visual ownership)

New Survival Needs Configuration
- Hunger
  - hungerRatePerSecond
  - maxHunger
  - seekFoodThreshold01
  - foodToEatPerMeal
  - eatDurationSeconds
  - starvationDamagePerSecond
- Sleep
  - tirednessRatePerSecond
  - maxTiredness
  - seekSleepThreshold01
  - sleepDurationSeconds
  - exhaustionDamagePerSecond

Food Quality / Subtype Configuration
- Assign `FoodDatabase` on the prefab to define edible resources via `ResourceDefinition` entries and per-food stats:
  - hunger restore values
  - eat time values
  - cooking requirement metadata
  - spoilage metadata

Gameplay Behavior
- Civilians continue their assigned jobs until needs cross thresholds.
- Hunger priority: go to best team storage with food.
- Sleep priority: go to nearest available same-team house.
- If no food/house is available long enough, civilians lose health.

Inspector Integration
- UnitInspectorUI now shows current hunger, tiredness, assigned house, and needs-related stats.


Crafting Role Split (current design)
- Hauler civilians handle crafting logistics:
  - Deliver input resources into crafting buildings first.
  - Remove crafted outputs to external storage only after input demand is satisfied.
- Non-hauler civilians assigned to crafting buildings should remain near work points to drive production progress.
- This avoids mixed pickup/dropoff behavior and keeps input/output directions explicit.


Latest notes
- Civilians attempt to auto-claim an available same-team house via shared House registry when initialized.
- Idle-role civilians path to their assigned house while inactive.
- Inspector house line now reports "Homeless" if no residence is assigned.
- While actively operating a crafting work point during an in-progress craft cycle, civilians will not divert to needs until that cycle is complete.
Compatibility fields (legacy UI/validator support)
- Civilian exposes the following runtime-read properties for inspector/tools compatibility:
  - speed
  - stopDistance
  - carryCapacity
  - gatherTickSeconds
  - harvestPerTick
  - foodToEatPerMeal
  - maxTiredness
  - maxHunger
  - hungerRatePerSecond
  - tirednessRatePerSecond
- Civilian also includes optional `foodDatabase` and `resourcesDatabase` references for food definition lookup.

Movement ownership update
- `MovementController` now owns movement behavior for civilians.
- `Civilian` no longer directly manipulates `NavMeshAgent` (for example, direct `isStopped` toggles or agent configuration).
- Civilian movement commands should continue to use `MovementController.MoveTo(...)`, with arrival checks via `MovementController.HasArrived()`.

Modular AI architecture update
- `Civilian` now uses an internal object-oriented FSM (`CivilianStateBase` + concrete state classes) for per-state behavior ownership.
- State transitions now call `SetState(...)`, which runs exit/enter hooks before switching handlers.
- Job/runtime systems now operate on `CivilianJobType`; legacy role-based setup paths were removed.


Latest component enforcement
- RequireComponent on Civilian now enforces core runtime controllers: Health, Movement, Carrying, Gathering, Needs, Housing, ConstructionWorkerControl, ToolController, JobController, TrainingController, and UpgradeController.

[2026-02 Needs integration update]
- Civilian needs behavior is now database-driven via `GameDatabase.needs` and `GameDatabase.needsActions`.
- Ensure the active GameDatabase points to:
  - `NeedsDatabase` containing `food`, `rest`, `water` NeedDefinitions
  - `NeedsActionDatabase` entries mapping those needs to seek-food/seek-rest decisions.
- Tired civilians now move slower automatically; verify `MovementController` + `NeedsController` are both present.


Building interaction targeting update
- Civilian building movement should be issued through `MovementController.MoveToBuildingTarget(...)`.
- `MovementController` now resolves both:
  - stop distance by `BuildingInteractionSettings`
  - closest interaction point by `BuildingInteractionPointController`
- For all building types used in civilian workflows (HQ, Node-related dropoff/storage chains, Barracks, Crafting buildings, Storage facilities, Houses), add correctly typed `InteractionPoint` markers so pickup/dropoff/input/output can path to the nearest valid point.


Update (2026-02-20)
- Hauler civilians can now accept crafting logistics tasks emitted from the registry-driven worker task queue without requiring craft-capable job conversion.
- When civilians remain without a valid job target for more than 10 seconds, they now wait at their assigned house interaction point (`BuildingInteractionPointType.House`) until a valid task can be assigned.


FSM ownership update (2026-02-20)
- Civilian state classes now own both execution (`Tick`) and state metadata used by UI/inspector (`TaskLabel` + state detail text).
- `CivilianStateBase` includes virtual metadata methods, and each concrete state overrides only what it needs.
- This removes centralized state-to-string switch blocks and keeps future state changes localized per class.
- FSM migration complete: legacy top-level state `Tick*` methods were removed from `Civilian`; each concrete `CivilianStateBase` derivative now contains full per-state execution logic in `Tick()`.

State tuning via ScriptableObject (2026-02)
- Civilian state timing is now configured through `CivilianStateSettings` assets.
- In the Civilian inspector, assign `stateSettings` to control:
  - search retry cadence
  - idle wander radius + min/max interval
  - idle no-task house-return delay
  - craft work-point stall repath timeout
- If unassigned, Civilian falls back to built-in defaults, and `SceneRequiredScripts` will log a diagnostic warning.

ScriptableObject state migration update (2026-02-22)
- Civilian FSM handlers are now instantiated as ScriptableObject-backed states at runtime.
- `CivilianStateBase` now derives from `ScriptableObject`; all concrete states initialize through `InitializeStateMachine()`.
- State lifecycle now includes explicit ScriptableObject cleanup through `DestroyStateMachine()` during `OnDestroy()`.
- This keeps civilian state ownership modular while preserving existing per-state TaskLabel/details metadata.

Debugging civilian stalls (2026-02)
- `Civilian` includes `enableDebugLogs`.
- Turn it on for a prefab/instance to log state transitions (`Idle -> SearchingNode`, etc.) and no-task-assigned traces when the worker remains idle/searching.
- Use this together with `DiagnosticUI` to identify missing storage/tasks/navigation links.

