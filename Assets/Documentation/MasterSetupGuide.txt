CubeWars Master Setup Guide
===========================

Purpose
- Central setup checklist for all currently known gameplay systems.
- Use this when creating a new scene, building prefab, unit prefab, resource node, or UI shell.

-----------------------------------------------------------------
1) Scene Bootstrap (required before gameplay)
-----------------------------------------------------------------
Create one bootstrap GameObject (for example: "_Systems") and attach:
- SceneRequiredScripts (runs scene-level required-script and missing-script-component validation)
- GameManager
- TeamStorageManager
- DiplomacyManager
- BuildPlacementManager
- BuildGridManager
- ResourceRegistry
- JobManager
- ProjectilePool

Recommended global managers also used by current scripts:

Production-chain managers (required for full crafting economy):
- CraftingJobManager
- ProductionNotificationManager

Optional compatibility manager:
- CraftingSystem (keeps ToolItem crafting calls functional)
- SaveLoadManager
- EventManager
- AIManager
- UnitManager
- CombatManager
- TeamColorManager
- WinConditionManager

Camera/input/UI scene objects:
- RTSCamera
- SelectionManager
- IMGUIInputBlocker
- BuildMenuUI
- UnitInspectorUI
- Minimap
- TaskBoardUI (if using role/task tracking)

Team setup (at least one):
- TeamBootstrap OR SixTeamBootstrap OR HQSpawner

-----------------------------------------------------------------
2) Headquarters + Team foundations
-----------------------------------------------------------------
HQ prefab minimum components:
- Building
- Headquarters
- TeamVisual (recommended)

Optional but commonly paired:
- ResourceStorageContainer
- ResourceStorageProvider (for team capacity and optional starting resources)
- ResourceDropoff (if civilians should deposit to HQ)

Important:
- Building.teamID must be set for each spawned HQ.
- BuildGridManager builds per-team grids around Headquarters objects.

-----------------------------------------------------------------
3) Buildable Building Prefab Setup
-----------------------------------------------------------------
A buildable structure prefab should usually include:
- Building (required for health/team/demolish hooks)
- BuildItemInstance (auto-added at runtime if missing)
- TeamVisual (if team colors are required)
- BuildingInteractionSettings (configure per-building civilian stop distances)
- BuildingPrefabValidator (optional runtime/component validation logging)

If it should occupy more than one grid cell:
- Add BuildingFootprint
  - width = X cells
  - depth = Z cells
  - worldOffset/extraYRotation optional

If it provides storage capacity:
- Add ResourceStorageContainer
- Add ResourceStorageProvider
  - capacities[] for provided capacity
  - optionally enable grantStartingResources and fill startingResources[]

If it accepts resource dropoff from civilians:
- Add ResourceDropoff

If it produces units:
- Add Barracks
- Configure producibleUnits[]

If it is defensive:
- Add DefenseTurret
- Add UnitCombatController if required by your combat flow

Build catalog linkage (catalog asset now stored under Assets/Data/Databases):
- Create/assign a BuildItemDefinition asset
  - prefab
  - costs[]
  - buildTime
  - yOffset/placementOffset
  - category/aiPriority
- Add definition to BuildingsDatabase so it appears in BuildMenuUI.
- Keep BuildingsDatabase.asset in Assets/Data/Databases/BuildingsDatabase.asset.
- BuildMenuUI auto-resolves this database in the following order: explicit inspector reference, GameDatabase.buildings, then editor fallback path Assets/Data/Databases/BuildingsDatabase.asset.
- Resources/BuildItems discovery remains a fallback only when no BuildingsDatabase source is available.

-----------------------------------------------------------------
4) Construction Site Prefab
-----------------------------------------------------------------
ConstructionSite prefab requirements:
- ConstructionSite component (required)

Recommended:
- TeamVisual
- Building-like visuals/health indicator as needed

BuildPlacementManager settings:
- useConstructionSites = true
- constructionSitePrefab assigned
- reserveResourcesForSites as desired

-----------------------------------------------------------------
5) Unit Prefab Setup
-----------------------------------------------------------------
Combat unit minimum:
- Unit
- Attackable
- UnitCombatController
- NavMeshAgent
- Selectable

Civilian unit minimum:
- Civilian
- NavMeshAgent
- Selectable
- (Optional) CharacterStats for carry/harvest/build modifiers

If civilians should appear in task systems:
- Ensure JobManager exists in scene.

-----------------------------------------------------------------
6) Resource Node Prefab Setup
-----------------------------------------------------------------
Resource node minimum:
- ResourceNode
  - type
  - remaining
  - maxGatherers (limits simultaneous gather jobs)

Registry hookup:
- ResourceRegistry in scene (ResourceNode auto-registers OnEnable).

Gathering behavior notes:
- Civilians reserve gather slots on target nodes.
- When a node is full, civilians pick the next closest available node.
- Auto-assignment fallback uses the node GameObject name token against ResourcesDatabase IDs/display names when `resource` is unassigned.

-----------------------------------------------------------------
7) Storage/Economy System Wiring
-----------------------------------------------------------------
Required scene components:
- TeamStorageManager
- TeamResources

Storage building wiring:
- ResourceStorageContainer handles actual per-building storage.
- ResourceStorageProvider adds/removes capacity and can optionally grant starting resources once.

Dropoff/pickup wiring:
- ResourceDropoff for valid deposit points.
- Civilians query nearest compatible storage via TeamStorageManager.


-----------------------------------------------------------------
7B) Production-chain Crafting Economy Setup
-----------------------------------------------------------------
Crafting building prefab minimum:
- CraftingBuilding (inherits Building)
- Define ProductionRecipe (inputs, outputs, craftTimeSeconds, batchSize, requiredJobType)
- Configure InputSlot + OutputSlot transforms
- Configure WorkPoints[] where workers physically stand to craft

Recommended crafting add-ons:
- ProductionStatusVisualizer (missing input / output full / no worker icons)
- ParticleSystem + AudioSource assigned in CraftingBuilding for production feedback

Worker specialization + assignment:
- Civilian now supports CivilianJobType (Generalist, Blacksmith, Carpenter, Farmer, Cook, Engineer)
- Recipe.requiredJobType gates who can operate the building
- Automatic assignment is handled by CraftingJobManager and building assignmentPriority
- Manual assignment can be performed through JobManager.AssignCivilianToCraftingBuilding(...)

Logistics workflow now expected:
1) Worker fetches required recipe input from nearest storage (cached storage lookup)

Crafting logistics rules (latest):
- Crafting stations should receive recipe inputs via direct deliveries from haulers/crafters, plus gatherers when the crafting station is their nearest valid dropoff for that carried resource.
- Crafted outputs should be hauled from the crafting station output queue to a different storage provider (do not route crafted output back into the station's own local container).
- Haulers should prioritize refilling crafting input buffers before resuming generic construction hauling.
- Crafting production can advance when assigned workers are occupying work points or standing within immediate working distance of the station/work points.
2) Worker delivers materials to building InputSlot
3) Worker moves to available WorkPoint and operates production
4) Outputs appear in building queue / OutputSlot
5) Worker carries crafted goods to nearest compatible storage

Throughput + expansion:
- Use maxWorkers, maxInputCapacityPerResource, maxOutputCapacityPerResource, craftingSpeedModifier
- Optional upgrades increase slots/speed/efficiency
- Recipes include forward-looking fields for power/fuel requirements and multi-tier chains

-----------------------------------------------------------------
8) Selection + Inspector System
-----------------------------------------------------------------
Selection flow:
- SelectionManager selects world objects.
- UnitInspectorUI receives selected object and renders contextual panels.
- DiagnosticUI provides a full-screen diagnostic overlay (toggle: D) for database/task/worker/system state and closes other gameplay IMGUI panels when opened.

Demolish button behavior:
- Appears for Building selections (including child-click selections via parent lookup).
- Enabled for player-team buildings.

-----------------------------------------------------------------
9) Grid + Placement System
-----------------------------------------------------------------
Required scene scripts:
- BuildGridManager
- BuildPlacementManager
- BuildMenuUI (if player build UI is needed)

Placement rules currently supported:
- Multi-cell footprint checks via BuildingFootprint (width/depth).
- Rotation (R key) affects footprint orientation.
- Optional reservation blockers via BuildCellReservation.
- Optional construction-site workflow.

-----------------------------------------------------------------
10) Quick validation checklist
-----------------------------------------------------------------
Before pressing Play, verify:
[ ] Scene has all required managers.
[ ] At least one team bootstrap path exists.
[ ] HQ prefabs have Building + Headquarters and valid team IDs.
[ ] BuildPlacementManager has constructionSitePrefab assigned (if enabled).
[ ] Build catalog entries point to valid prefabs.
[ ] Buildable prefabs needing larger footprints have BuildingFootprint set.
[ ] Storage buildings have both ResourceStorageContainer and ResourceStorageProvider.
[ ] Crafting buildings have CraftingBuilding + ProductionRecipe + input/output/workpoint transforms configured.
[ ] CraftingJobManager + ProductionNotificationManager exist in scene for assignment/bottleneck alerts.
[ ] Resource nodes have ResourceNode with type/remaining/maxGatherers configured.
[ ] UI objects exist (SelectionManager, UnitInspectorUI, BuildMenuUI, TaskBoardUI if used, DiagnosticUI for runtime deep diagnostics).

-----------------------------------------------------------------
10B) Crafting Logistics Consistency Notes (latest)
-----------------------------------------------------------------

Crafting logistics consistency (latest)
- Crafting hauler assignments now preserve CivilianRole.Hauler when assigned to a CraftingBuilding.
  This is required so requireHaulerLogistics buildings continue executing fetch/deliver loops.
- On CraftingBuilding prefabs, keep exactly one ResourceStorageContainer in the prefab hierarchy.
  Multiple local storage containers can split inspector-visible storage from logistics targets.
- Avoid pairing ResourceDropoff with CraftingBuilding unless intentionally using mixed logistics.

-----------------------------------------------------------------
11) RTS Controls + Combat Modernization (new)
-----------------------------------------------------------------
Selection + input:
- SelectionManager now supports:
  - Left click single select
  - Left-drag selection rectangle for box select
  - Shift + click/drag to add or remove from selection
  - Hover highlighting through Selectable.SetHovered
- Right-click contextual commands:
  - Ground: Move order (formation offsets from UnitManager)
  - Enemy Attackable: Attack order via UnitCombatController.SetManualTarget
  - ResourceNode: Civilian gather order via Civilian.AssignPreferredNode
- Hold A + Right Click: Attack-move order for combat units.

Unit combat behavior:
- UnitCombatController now includes:
  - visionRange (separate from attack range)
  - stance-aware auto targeting (Hold / Guard / Aggressive)
  - behaviorState debug state
  - attack-move destination tracking
  - faster target refresh (targetRefreshSeconds)
- Attack and sight circles can be toggled with R for the primary selected combat unit.

Combat responsiveness + feedback:
- Projectile uses consistent MoveTowards travel and impactDistance.
- Attackable supports optional hit flash feedback (renderer color pulse).
- Unit nav agents receive varied avoidance priority to reduce clumping.

HQ diplomacy selection fix:
- UnitInspectorUI HQ diplomacy panel now resolves Headquarters using parent lookup,
  so clicking enemy HQ colliders reliably shows team and diplomacy controls.

Main menu expansion:
- MainMenuUI now includes "Match Setup (AoE Style)" with:
  - Team rows
  - Team color (RGB)
  - AI difficulty
  - Starting resources
  - Diplomacy stance (Ally/Neutral/Enemy)
- Setup can be applied to DiplomacyManager before game start.

-----------------------------------------------------------------
11) Civilian Needs + Housing Setup
-----------------------------------------------------------------
Civilian prefab additions (new survival system):
- Gathering defaults: gatherTickSeconds = 1.0 and harvestPerTick = 1 (baseline 1 resource/second before tool bonuses).
- Food tuning: hungerRatePerSecond, maxHunger, seekFoodThreshold01, foodToEatPerMeal, eatDurationSeconds, starvationDamagePerSecond
- Sleep tuning: tirednessRatePerSecond, maxTiredness, seekSleepThreshold01, sleepDurationSeconds, exhaustionDamagePerSecond
- Assign a FoodDatabase (Assets/Data/DatabaseScripts/FoodDatabase.cs) to drive food hunger, eat time, cooking, and spoilage data.

House building setup:
- Add House component (inherits Building)
- Configure prestige, comfort, storage, maxInhabitants
- Ensure teamID is assigned correctly at placement/spawn time

Behavior summary:
- Hungry civilians move to best available food storage.
- Tired civilians move to nearest valid house.
- If needs are ignored, civilians take survival damage.

Editor tooling:
- Use CubeWars/Tools/Resource Authoring to quickly create new ResourceNode prefabs.

-----------------------------------------------------------------
12) TeamBootstrap advanced spawn configuration (new)
-----------------------------------------------------------------
TeamBootstrap now supports per-team startup lists:
- civilianGroups[]: choose different civilian prefabs, counts, CivilianRole, and CivilianJobType.
- startingUnitGroups[]: choose multiple combat unit prefabs and counts.
- startingBuildings[]: choose building prefabs and exact grid coordinates/rotations for initial placement.

Starting building placement behavior:
- Uses BuildGridManager centered-footprint queries per team grid.
- Uses BuildingFootprint width/depth (rotation-aware).
- Rejects blocked/out-of-bounds/occupied cells.
- Marks every footprint cell occupied through BuildGridOccupant.

This means startup buildings now obey the same occupancy model as manual build placement.

Related docs:
- See Assets/Documentation/BuildingFootprint.txt for full prefab alignment rules.

UI behavior notes (latest)
- TaskBoardUI tab toggle now syncs with RTSGameSettings display flags.
- UnitInspectorUI includes Demolish Building action and expanded building stats (including Barracks/crafting/storage/stop-distance info).

-----------------------------------------------------------------
Storage/Crafting Logistics Fix Notes (Latest)
-----------------------------------------------------------------
- ResourceStorageProvider capacities are now applied only to the local ResourceStorageContainer on that building.
- This prevents crafting/storage buildings from exposing unrelated resource capacities just because other team storages exist.
- Building inspector storage should be treated as local-only: inspect per-building stored/capacity values, not team-global totals.
- Gatherers/haulers should only deposit to storages with free capacity for the carried resource type.
- If a target storage fills during transit, civilians should retarget another valid storage instead of dropping carried materials.
Reference
- Detailed crafting prefab walkthrough: Assets/Documentation/CraftingBuildingPrefabSetup.txt


-----------------------------------------------------------------
13) Per-resource storage send/receive controls (new)
-----------------------------------------------------------------
Resource storages now support per-resource hauling flow permissions.

Where to configure in Unity:
- On each `ResourceStorageContainer` component.
- Inspector displays one row per ResourceType:
  `<Resource> Flow (Hauler Pickup/Dropoff)`.

Flow mode meaning:
- Disabled: no hauling in or out for that resource.
- ReceiveOnly: haulers can drop off only.
- SupplyOnly: haulers can pick up only.
- ReceiveAndSupply: both directions allowed.

Behavior impact:
- TeamStorageManager nearest-storage queries now filter by flow mode:
  - pickup requests only consider `SupplyOnly` / `ReceiveAndSupply`.
  - drop-off requests only consider `ReceiveOnly` / `ReceiveAndSupply`.
- Crafting output delivery also respects target storage `CanReceive` flow settings.
- UnitInspectorUI storage panel now displays flow state per resource at runtime.

Prefab setup reminder:
- For each crafting building, verify every relevant storage resource row is configured intentionally (not left ambiguous).
- Keep exactly one ResourceStorageContainer per crafting building hierarchy.


- Simplified crafting workflow baseline:
  - Haulers are responsible for logistics only (deliver recipe inputs to crafting buildings, then remove outputs).
  - Assigned crafters/non-haulers should stand near workPoints to enable production and should not run logistics loops.
  - Input resources should only be delivered into crafting building input buffers.
  - Output resources should only be taken away from crafting building output queues.


-----------------------------------------------------------------
Latest Updates (Hauling, Housing, UI, Bootstrap)
-----------------------------------------------------------------
- Crafting hauling now requests full missing input volume from storage (bounded by civilian carry capacity), instead of capping each pickup request to building input-capacity-per-resource.
- Civilians now auto-attempt house assignment from a shared runtime house registry and retain a personal assigned house when available.
- Inactive (Idle-role) civilians return to their assigned house when idle.
- House instances now receive randomized names on spawn for easier identification in inspector/debugging.
- Crafting workers standing at a work point are now protected from need-driven task interruption while a craft cycle is actively in progress.
- UnitInspectorUI Storage tab now displays crafting input-buffer and output-queue amounts for CraftingBuilding selections.
- UnitInspectorUI now labels civilians without homes as "Homeless".
- UnitInspectorUI Overview now exposes a demolish button for Barracks selections; DefenseTurret already inherits Building so demolish is available through the standard building path.
- Added WorldProgressBar script as a visual twin of WorldHealthBar for future construction/upgrade progress display binding.
- TeamBootstrap HQ spawn logic now snaps HQ world X/Z to BuildGridManager cell size so startup HQ placement aligns with the building grid.

-----------------------------------------------------------------
14) Unified civilian jobs + job tools + housing modifiers (new)
-----------------------------------------------------------------
Civilian job model now uses a unified `CivilianJobType` registry:
- Includes former role-only types and former specialization-only types in one enum.
- `CivilianRole` is now treated as a legacy mirror for older systems/UI.
- Runtime mapping is handled by `CivilianJobRegistry`.

House behavior updates:
- Houses automatically force their attached `ResourceStorageContainer` flow settings to `ReceiveOnly` for all resources.
- Idle civilians with job `Idle` remain close to their assigned house and perform short random wander movement near it.
- While sleeping/resting, residents attempt to consume food from their own house storage first.
- House stat modifiers now apply to residents:
  - Prestige: +10% movement speed per level.
  - Comfort: -10% tiredness gain per level.

Tool registry updates:
- New unified tool registry: `CivilianToolRegistry`.
- Civilians auto-pick one copy of each eligible tool from team tool storage (`TeamInventory`) and can hold multiple unique tools.
- Tool eligibility:
  - Job-specific tools only for matching job.
  - Universal tools for all civilians.
- Current tool set and bonuses:
  - Pickaxe (Gatherer): +50% gathering speed.
  - Backpack (Hauler): +50% carry capacity.
  - Spanner (Engineer): +50% crafting speed contribution.
  - Trowel (Builder): +50% build speed.
  - RunningShoes (All civilians): +50% movement speed.

Crafting speed integration:
- `CraftingBuilding` now reads worker tool multipliers and applies them to craft duration.


Latest civilian crafting/needs behavior (Fixes 1-3)
- Crafting progress now scales with active (present) workers only; assigned workers who are not physically at active work range do not advance production.
- CraftingBuilding can auto-unassign inactive auto-assigned workers after ~30s to recover from deadlocks.
- Civilians now prioritize consuming food from their assigned house first when nearby (bypassing storage flow restrictions), then fall back to global storage search.
- Food search prioritizes house storage containers higher when they contain edible resources.
- Need interruption guard for crafters now only suppresses hunger/sleep interruption when the civilian is actually at the work point and production is in progress.
- After food/sleep, civilians with crafting assignments are forced back to GoingToWorkPoint to prevent idle loopholes.
- If a civilian stalls while trying to reach crafting work point for >10s, assignment is cleared to prevent permanent lock.

Detailed build-menu database format support (new)
- BuildMenuUI now reads `BuildingsDatabase.buildings` (detailed `BuildingDefinition` entries) as the primary catalog source.
- At runtime, each valid detailed entry is converted into a temporary `BuildItemDefinition` so existing placement and spending systems continue to work without scene rewiring.
- Build menu rows now include extra details from `BuildingDefinition` when available: build time, max HP, worker slots, and storage capacity.
- Category tab grouping for detailed entries uses `subCategory` first, then `category` enum name.
- Construction costs are translated from `BuildingDefinition.constructionCost` resources into runtime `ResourceCost[]`; unsupported resource IDs are skipped.


-----------------------------------------------------------------
Latest resource database migration notes
-----------------------------------------------------------------
- ResourceType enum has been moved out of `ResourcesDatabase.cs` into `Assets/Data/Definitions/ResourceType.cs`.
- `ResourcesDatabase` now supports string-id and `ResourceDefinition` category lookups (`TryGetById`, `IsCategory`, `IsCategoryById`).
- ResourceSpawner enforces Raw-only resource spawning through ResourceDefinition category checks when `resourcesDatabase` is assigned.
- CraftingBuilding enforces Refined-only outputs through ResourceDefinition category checks when `resourcesDatabase` is assigned.
- Civilian food behavior now reads edible entries from `FoodDatabase` (ResourceDefinition-based), then resolves runtime storage resources from those definitions.


[2026 Data-driven resources migration]
- ResourceType enum has been removed from runtime data flow.
- All resource references should use ResourceDefinition assets (or resource IDs resolved via ResourcesDatabase).
- Food behavior is now resolved through FoodDatabase + FoodDefinition (hungerRestore, eatTime, requiresCooking, perishable, spoilTime).
- Civilians, storage, crafting/recipes, and UI should query FoodDatabase for edible checks and hunger restore values.

[2026 Editor tools reorganization + database stat hooks]
- Editor tools were moved under `Assets/Editor/Tools` and inspector-only custom editors under `Assets/Editor/Inspectors`.
- Utility automation scripts were moved to `Assets/Tools/Automation/Ahk`.
- Editor-generated outputs are now standardized under `Assets/Documentation/EditorToolsOutput` with categories:
  - `ScriptIndex`
  - `Analysis`
  - `Reports`
  - `Exports`
- Updated Unity menu organization:
  - `Tools/CubeWars/Documentation/*`
  - `Tools/CubeWars/Analysis/*`
  - `Tools/CubeWars/Validation/*`
  - `Tools/CubeWars/Database/*`

Database-driven runtime stat setup (new)
- Add a `GameDatabaseLoader` in your scene and assign the `GameDatabase` asset.
- Unit prefabs can now set `Unit.unitDefinitionId` to pull key stats from `UnitsDatabase` at runtime:
  - max health
  - move speed
  - attack damage/range/cooldown
  - armor
- Civilian prefabs can set `Civilian.unitDefinitionId` (default: `civilian`) to pull max health, move speed, and carry capacity.
- Building prefabs can set `Building.buildingDefinitionId` to pull max health from `BuildingsDatabase`.
- `DefenseTurret` also pulls attack range/damage from building database values when available.

[2026-02 maintenance updates]
- Removed unsupported `#nullable` directive usage from `Assets/Editor/GameDatabaseDTO.cs` to avoid CS1024 compile errors in older Unity C# compilation paths.
- Optimized `WinConditionManager` to run victory scans on a timer and stop processing after a winner is declared.
- Optimized AI resource/defense scripts (`AIResourceManager`, `AIThreatDetector`) by caching component references and using squared-distance checks to reduce per-tick overhead.

- Database editor split update: each database now has its own menu entry under Tools/CubeWars/Database (Buildings, Foods, Jobs, Recipes, Resources, Tools, Units) instead of a single tabbed Game Database editor window.
- Editor script layout: each database window now lives in its own script file under `Assets/Data/DatabaseEditors` (`BuildingsDatabaseEditorWindow.cs`, `FoodsDatabaseEditorWindow.cs`, `JobsDatabaseEditorWindow.cs`, `RecipesDatabaseEditorWindow.cs`, `ResourcesDatabaseEditorWindow.cs`, `ToolsDatabaseEditorWindow.cs`, `UnitsDatabaseEditorWindow.cs`), with shared logic kept in `GameDatabaseEditorWindow.cs`.

[2026-02 Tool bonus system scaling update]
- `BonusDefinition` now supports safe runtime matching through `Matches(ResourceDefinition target)` so Resource-targeted bonuses correctly match by shallow-copied resource ID (instead of requiring object-reference equality).
- `BonusCalculator.GetFinalMultiplier(job, tool, resource)` now handles null-safe defaults (`job.baseSkill` and `tool.baseEfficiency` fallback to 1.0) and applies all matching tool bonuses against the job resource/category.
- This enables data-driven tool behavior for both physical and knowledge tools (e.g., `Thinking Cap`) using the same `BonusDefinition` model.
- Keep authoring tool/resource/category entries through databases (`ToolsDatabase`, `ResourcesDatabase`) to preserve consistent IDs for runtime matching.

Maintenance note (2026-02 civilian logistics)
- Civilian deposit state routing now returns to the correct work loop by job type after dropoff:
  - Gatherer -> SearchingNode
  - Builder -> SearchingBuildSite
  - Hauler -> SearchingSupplySite
- Gatherers now only target valid ResourceNode instances that still have resources and a configured ResourceDefinition.
- HQ prefab/resource storage setup remains required: keep ResourceStorageContainer + ResourceStorageProvider on HQ so spawned teams have physical capacity for gatherer/hauler/builder logistics.
- Gatherer deposit flow now supports both ResourceStorageContainer and ResourceDropoff targets; after a successful deposit civilians must return to `SearchingNode` so gathering resumes automatically.

[2026 Capability-profile jobs + unified task dispatcher]
- Add `WorkerTaskDispatcher` to the scene bootstrap (`_Systems`) to centralize worker-task assignment by capability.
- Add `WorkerTaskGenerationSystem` to the scene bootstrap to scan world conditions and emit gather/haul/build/craft task packets.
- Keep `JobManager` for civilian registration/UI role counts, but use dispatcher-driven assignment for crafting/manual assignment paths.
- Configure civilian `jobDefinition` ScriptableObject references (Assets/Data/Definitions/Jobs/*) so capability checks are fully data-driven.
- `JobDefinition` is now a ScriptableObject capability profile (`id`, `displayName`, `defaultJobType`, `legacyRole`, `capabilities`, `allowedTools`).
- Jobs database should reference job profile assets instead of inline hard-coded job entries.
- Job/task enums are now collocated under `Assets/Data/Enums` for data discoverability (`CivilianJobType`, `CivilianRole`, `WorkerCapability`, `WorkerTaskType`).

[2026-02 civilian gathering + building database sync]
- Civilians now depend on storage capacities that can be auto-populated from BuildingsDatabase storage definitions via ResourceStorageProvider.
- Storage-providing buildings marked as storage in BuildingsDatabase now guarantee at least 1000 capacity per resource when registering storage.
- Building runtime scripts now resolve their building definition IDs from placed BuildItemInstance/name fallback and apply database-authored stats in code paths (health/house stats/turret stats/factory timings/crafting worker-recipe setup).
- BuildingsDatabase catalog now includes HQ, Barracks, and Defense Turret prefab entries used by runtime build/starting-building flows.

- Legacy retired economy panel references were removed; use TaskBoardUI + UnitInspectorUI for economy/debug visibility.

- Headquarters now retries starting-resource deposits until team storage capacity is available at runtime; keep HQ storage provider/container wiring valid.
- TaskBoardUI was expanded with workforce state breakdown, node/construction/crafting fulfillment stats, and dispatcher queue visibility for deeper debugging.

[2026-02 gather task slot dispatch + worker availability]
- WorkerTaskGenerationSystem now queues gather requests per open `ResourceNode.maxGatherers` slot instead of one gather request per node, and subtracts already queued gather requests for the same node to avoid queue flooding.
- WorkerTaskDispatcher now exposes per-node queued gather counts and only dispatches to civilians that are currently available (`Idle` or `Searching*`) to prevent mid-task reassignment churn.
- SceneRequiredScripts validator now explicitly requires `WorkerTaskDispatcher` and `WorkerTaskGenerationSystem` in scene bootstrap validation.

Workforce troubleshooting update (latest)
- Civilian prefab does not need its own ResourceStorageContainer/ResourceStorageProvider to gather/haul.
- Ensure every Civilian prefab has a valid `unitDefinitionId` that exists in UnitsDatabase.
- Ensure every ResourceNode has `resource` assigned and that ResourceDefinition exists in ResourcesDatabase.
- Use BuildingPrefabValidator on Building/Civilian/ResourceNode prefabs to log missing components and data mismatches.
- SceneRequiredScripts now includes workforce/resource data diagnostics for these checks at scene validation time.
- TaskBoardUI "Haulers Active" now counts both construction hauling and crafting input/output hauling states.

-----------------------------------------------------------------
11) Storage Facility + Inspector Recipe Selection (latest)
-----------------------------------------------------------------
Storage facility prefab setup:
- StorageFacility prefab should include:
  - StorageFacility (new script)
  - ResourceStorageProvider
  - ResourceStorageContainer
- StorageFacility auto-generates per-resource capacity from ResourcesDatabase and BuildingDefinition storageSettings.capacity.
- Specialized prefabs can filter categories using StorageFacility.allowedCategories:
  - FoodStorageFacility (Food)
  - RawMaterialStorageFacility (Raw)
  - ToolStorageFacility (Tool)

Build menu integration:
- Add storagefacility, foodstoragefacility, rawmaterialstoragefacility, and toolstoragefacility entries to BuildingsDatabase.
- Set BuildingDefinition.category to Storage and subCategory to "Storage" so BuildMenuUI groups them correctly.

Crafting inspector setup:
- UnitInspectorUI Production tab now lists all RecipesDatabase entries and supports in-game recipe switching.
- Inspector now shows recipe details:
  - Required job type
  - Inputs
  - Outputs
  - Craft time / batch size
- Ensure GameDatabase.recipes references RecipesDatabase.asset and contains valid entries.

-----------------------------------------------------------------
12) Database reliability + startup UI defaults (latest)
-----------------------------------------------------------------
- Keep one active GameDatabaseLoader in gameplay scenes and assign GameDatabase.asset.
- Runtime systems now resolve the loader-backed database first to avoid early-Awake null database warnings.
- Use Assets/Data/Databases/ResourcesDatabase.asset as the single ResourcesDatabase asset reference.
- Task board now starts hidden and is toggled with Tab.
- Minimap now starts hidden and is toggled with M.
- Default gameplay speed is now 3x.
- UnitInspectorUI panel height was increased to reduce congestion, and inspector/task board text size is slightly increased.

-----------------------------------------------------------------
11) Database Content Baselines (RTS Economy Expansion)
-----------------------------------------------------------------
Current expected minimum content levels:
- ResourcesDatabase: 50+ resources
- JobsDatabase: 10+ job definitions
- FoodDatabase: 20+ foods
- RecipesDatabase: 40+ recipes
- ToolsDatabase: 20+ tools

Notes:
- Resource ids should be normalized-friendly (snake_case recommended) so runtime systems can resolve by id/display name.
- Recipes should include valid input/output resources; runtime now skips invalid entries safely but clean data is still recommended.

-----------------------------------------------------------------
12) TeamBootstrap Workforce + Starter Tools
-----------------------------------------------------------------
TeamBootstrap supports startup by explicit civilian job roster:
- Enable `spawnOneCivilianPerJob`
- Configure `startingJobTypes`
- Provide `workerPrefab`

Default starting roster should include one civilian for each main job:
Gatherer, Builder, Hauler, Crafter, Farmer, Technician, Scientist, Engineer, Blacksmith, Carpenter, Cook.

Starter tools:
- Civilians now receive a starting tool profile appropriate to their job at spawn/job assignment time.
- Keep ToolsDatabase populated with matching gameplay tools so progression/crafting can extend those defaults.

-----------------------------------------------------------------
13) ResourceNode Auto-Resolve Rule
-----------------------------------------------------------------
ResourceNode manual assignment is still supported and takes priority.
If no resource is manually assigned:
- ResourceNode attempts to auto-resolve by matching node GameObject name to a resource id/display key from loaded/global ResourcesDatabase.

This allows rapid map authoring when node names follow resource ids.

-----------------------------------------------------------------
Latest workforce/crafting reliability updates
-----------------------------------------------------------------
- WorkerTaskGenerationSystem now generates Gather tasks continuously from open ResourceNode slots and no longer blocks gathering whenever Build/Haul/Craft tasks exist.
- Crafting jobs now carry required recipe job metadata to avoid assigning the wrong worker specialization.
- Civilians can auto-switch to the required crafting job when they accept a valid craft task.
- CraftingBuilding now supports an in-world progress bar (WorldProgressBar) to visualize production progress.
- TeamBootstrap can spawn a starter set of specialist crafting workers and auto-assign recipes across up to six crafting buildings per team.
- UnitInspectorUI Production tab now includes:
  - a status reason string (why production is blocked/not started),
  - scrollable recipe selector,
  - scrollable recipe detail panel.

- Construction build/haul task generation is demand-limited per site to reduce assignment thrashing.
- Crafting worker task generation is slot-aware (assigned + queued up to CraftingBuilding.GetMaxWorkers).
- CraftingBuilding includes `maxAssignedHaulers` (default 1) to cap hauler assignments per building.

Crafting worker registration reliability (latest)
-----------------------------------------------------------------
- Civilians assigned through WorkerTaskDispatcher craft tasks must also register with the target CraftingBuilding worker list.
- If a civilian leaves or switches crafting buildings, clear/reassign through Civilian assignment APIs so the building worker registry stays synchronized.
- Symptom of desync: crafting worker appears at the work point but building status still reports 0 assigned workers and keeps queuing craft-worker tasks.


-----------------------------------------------------------------
Civilian controller split (latest)
-----------------------------------------------------------------
- Civilian logic now relies on dedicated components: HealthComponent, MovementController, CarryingController, GatheringControl, ConstructionWorkerControl, NeedsController.
- Add CivilianRegistry-aware systems by querying CivilianRegistry.All instead of scene-wide finds where possible.
- NeedsDatabase.asset now expects baseline civilian needs including toilet and entertainment plus other quality-of-life needs.
[2026-02 civilian compatibility accessor update]
- Civilian now exposes legacy inspector/runtime accessors again (`speed`, `stopDistance`, `carryCapacity`, `gatherTickSeconds`, `harvestPerTick`, `foodToEatPerMeal`, `maxTiredness`, `maxHunger`, `hungerRatePerSecond`, `tirednessRatePerSecond`).
- Civilian once again surfaces optional `foodDatabase` and `resourcesDatabase` references used by needs/validator tooling.
- SceneRequiredScripts civilian diagnostics now warn when both food database references are unset.

[2026-02 civilian movement ownership cleanup]
- Civilian movement control is centralized in `MovementController`.
- `Civilian` no longer directly configures or stops `NavMeshAgent`; movement commands route through `MovementController.MoveTo(...)` and arrival checks through `MovementController.HasArrived()`.
- Keep both `MovementController` and `NavMeshAgent` on civilian prefabs (the agent remains required by `MovementController`).


-----------------------------------------------------------------
11) Housing + Interaction Point System (2026-02)
-----------------------------------------------------------------
Housing:
- Add HousingRegistry to the scene.
- Civilian prefab now requires HousingController; housing assignment/lookup is registry-driven.
- House registration is automatic via House.OnEnable/OnDisable.

Building Interaction Points:
- Add BuildingInteractionPointController to building prefabs.
- Add one or more InteractionPoint child objects and set pointType:
  - Storage: civilian deposit/withdraw approach target
  - CraftInput/CraftOutput: crafting logistics approach targets
  - CraftWork: worker workstation points
  - House: optional sleep/house-specific interaction target
- CraftingBuilding uses InteractionPoint(type=CraftWork) for production worker positioning.
- Worker task generation now caps crafting job requests to available work points (one job per point).

Migration notes:
- StorageFacility legacy interactionPoint field was removed in favor of InteractionPoint components.
- If civilians stop short of storage/crafting interactions, verify NavMesh reachability to the selected InteractionPoint child transforms.

[2026-02 modular civilian AI + job cleanup]
- `Civilian` now enforces required runtime controllers directly on its GameObject (`HealthComponent`, `MovementController`, `CarryingController`, `GatheringController`, `NeedsController`, `HousingController`, `ConstructionWorkerControl`).
- Civilian update flow now runs through an internal object-oriented FSM dictionary of concrete state classes (`CivilianStateBase` derivatives).
- Legacy `CivilianRole` runtime usage was removed from worker systems/UI flows; worker counting and assignment now use `CivilianJobType`.
- Job definition assets/scripts no longer rely on `legacyRole`; jobs are authored around `defaultJobType` + capability/tool data.
- Job database assets under `Assets/Data/Databases/Jobs` were cleaned to remove serialized `legacyRole` fields.
- Civilian food and construction targeting paths now prefer registries/managers (`TeamStorageManager`, `ConstructionRegistry`) instead of scene-wide object scans.


[2026-02 compile compatibility hotfix]
- `CivilianRegistry` exposes `GetAll()` again for systems that still consume list-style access in diagnostics/validation flows.
- `UnitInspectorUI` now includes a safe `DrawRoleButtons(Civilian)` implementation to keep inspector compilation stable after legacy role removal.
- `Civilian` construction-site search now iterates `IReadOnlyList<ConstructionSite>` via `.Count` indexing (not `.Length`).


-----------------------------------------------------------------
Component auto-wiring updates (2026-02)
-----------------------------------------------------------------
The following gameplay scripts now enforce required dependencies with RequireComponent:
- Civilian: HealthComponent, MovementController, CarryingController, GatheringController, NeedsController, HousingController, ConstructionWorkerControl, ToolController, JobController, TrainingController, UpgradeController.
- Unit: NavMeshAgent, UnitCombatController.
- Headquarters: BuildingInteractionPointController.
- ConstructionSite: BuildGridOccupant.
- CraftingBuilding: ResourceStorageContainer.
- House: ResourceStorageContainer.
- StorageFacility: ResourceStorageProvider, ResourceStorageContainer.


SceneRequiredScripts missing-script alert behavior (2026-02)
- Scene validation now treats TeamBootstrap, SixTeamBootstrap, and HQSpawner as valid alternatives for team bootstrap.
- Missing MonoBehaviour references are now reported with explicit GameObject hierarchy paths to speed up scene cleanup.
- The validator prints the first 20 missing-script object paths, then emits an overflow summary if more are found.

Prefab validator scope expansion (2026-02)
- BuildingPrefabValidator now supports validation of combat-unit prefabs (`Unit`) in addition to Building, Civilian, and ResourceNode prefabs.
- Combat-unit validation checks required gameplay components (`Attackable`, `UnitCombatController`, `NavMeshAgent`) and warns for missing `Selectable`, `WeaponComponent`, or unknown `unitDefinitionId` entries.
- Recommended workflow: keep BuildingPrefabValidator on reusable gameplay prefabs and run Validate Building Components before committing prefab changes.


Update (2026-02-20)
- Farm.cs has been removed. Use CraftingBuilding + ProductionRecipe for food production instead of legacy farm scripts.
- Unit and Civilian `unitDefinitionId` values should be selected from UnitsDatabase (Unit uses inspector dropdown).
- UnitsDatabase now includes common baseline entries: Civilian, Villager, Militia, Archer, Spearman, Swordsman, Knight, Scout, Priest, Catapult.
- WorkerTaskGenerationSystem now creates separate crafting requests for production workers and haulers so `maxAssignedHaulers` is respected.
- Gather tasks now force the assigned node in Civilian state flow (SearchingNode -> GoingToNode) to align task registry requests with actual assignment behavior.

[2026-02 Need-action AI update]
- Assign `GameDatabase.needs` and `GameDatabase.needsActions` for all scenes using civilians.
- `NeedsDatabase` must contain (minimum) `food`, `rest`, and `water` ids if you want default civilian survival tuning.
- `NeedsActionDatabase` should be populated with need-action thresholds/priorities so civilians can route into `SeekingFoodStorage` / `SeekingHouse` via the state machine.
- Civilians now take dehydration damage in addition to starvation/exhaustion when water need is maxed.
- High tiredness now reduces civilian movement speed automatically.


[2026-02 civilian movement + interaction point routing]
- Civilian building-target movement is now centralized through `MovementController`.
- `MovementController` is responsible for:
  - resolving per-building stop distances via `BuildingInteractionSettings`
  - resolving closest interaction-point targets via `BuildingInteractionPointController`
  - issuing the final `NavMeshAgent` destination
- Ensure all building prefabs that civilians interact with (HQ, Resource Nodes with storage/dropoff chains, Barracks, Crafting, Storage Facility, House, Construction targets) include correctly typed `InteractionPoint` children under a `BuildingInteractionPointController`.
- For storage pickup/dropoff and crafting input/output, civilians now target the closest valid interaction point first; fallback remains the building transform when no matching point exists.


Update (2026-02-20, crafting + idle behavior)
- CraftingBuilding production work location support is now fully InteractionPoint-driven (`BuildingInteractionPointType.CraftWork`).
- Legacy `workPoints[]` authoring for CraftingBuilding has been removed from runtime behavior.
- Crafting buildings now emit change notifications only when production state actually changes, which keeps registry-driven task generation accurate and reduces queue churn.
- Registry-driven crafting jobs now include explicit Hauler craft jobs; haulers can accept these without being forced into Craft-capability job types.
- Civilians that cannot find suitable work for more than ~10 seconds will path to their assigned house `InteractionPoint` (`BuildingInteractionPointType.House`) and wait there until eligible work appears.

[2026-02 civilian housing + skill enum cleanup]
- Housing responsibilities are centralized in `HousingController` (assignment, target selection/claiming, house bonuses, and house food consumption helpers).
- Homeless civilians now periodically retry house assignment via `HousingController` recheck ticks (no scene setup changes required).
- Legacy `SkillType.cs` has been removed; `CharacterStats` now uses `CharacterSkillType` defined in `CharacterStats.cs`.

Maintenance note (2026-02 civilian state-machine refactor)
- No new required scene scripts were added.
- Civilian movement/arrival checks now share helper pathways for building targets and explicit world positions, reducing duplicated state transition code.
- Civilian search retry timing (build/supply scans) now uses a common retry helper to keep retry cadence consistent.
- Civilian need-action timing (eat/sleep) now uses a shared timer helper for completion thresholds.
- Legacy civilian deposit methods (`TickGoDeposit`, `TickDeposit`) were removed; active deposit flow remains `FindDepositStorage -> GoingToDepositStorage -> Depositing`.


FSM refactor note (2026-02-20)
- Civilian FSM presentation metadata (task label + state details text) is now owned by the concrete state classes instead of centralized `switch(state)` blocks.
- `CivilianStateBase` now exposes virtual task/detail methods so each state can define its own inspector-facing strings.
- Scene setup requirements are unchanged; this is an internal Civilian architecture cleanup for maintainability.
- Civilian FSM execution has been fully moved into concrete state classes: each state now owns its complete `Tick()` body, and legacy `Tick*` state methods were removed from `Civilian`.
