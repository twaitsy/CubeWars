CubeWars Master Setup Guide
===========================

Purpose
- Central setup checklist for all currently known gameplay systems.
- Use this when creating a new scene, building prefab, unit prefab, resource node, or UI shell.

-----------------------------------------------------------------
1) Scene Bootstrap (required before gameplay)
-----------------------------------------------------------------
Create one bootstrap GameObject (for example: "_Systems") and attach:
- GameManager
- TeamStorageManager
- DiplomacyManager
- BuildPlacementManager
- BuildGridManager
- ResourceRegistry
- JobManager
- ProjectilePool

Recommended global managers also used by current scripts:

Production-chain managers (required for full crafting economy):
- CraftingJobManager
- ProductionNotificationManager

Optional compatibility manager:
- CraftingSystem (keeps ToolItem crafting calls functional)
- SaveLoadManager
- EventManager
- AIManager
- UnitManager
- CombatManager
- TeamColorManager
- WinConditionManager

Camera/input/UI scene objects:
- RTSCamera
- SelectionManager
- IMGUIInputBlocker
- BuildMenuUI
- UnitInspectorUI
- EconomyUI
- Minimap
- TaskBoardUI (if using role/task tracking)

Team setup (at least one):
- TeamBootstrap OR SixTeamBootstrap OR HQSpawner

-----------------------------------------------------------------
2) Headquarters + Team foundations
-----------------------------------------------------------------
HQ prefab minimum components:
- Building
- Headquarters
- TeamVisual (recommended)

Optional but commonly paired:
- ResourceStorageContainer
- ResourceStorageProvider (for team capacity and optional starting resources)
- ResourceDropoff (if civilians should deposit to HQ)

Important:
- Building.teamID must be set for each spawned HQ.
- BuildGridManager builds per-team grids around Headquarters objects.

-----------------------------------------------------------------
3) Buildable Building Prefab Setup
-----------------------------------------------------------------
A buildable structure prefab should usually include:
- Building (required for health/team/demolish hooks)
- BuildItemInstance (auto-added at runtime if missing)
- TeamVisual (if team colors are required)
- BuildingInteractionSettings (configure per-building civilian stop distances)
- BuildingPrefabValidator (optional runtime/component validation logging)

If it should occupy more than one grid cell:
- Add BuildingFootprint
  - width = X cells
  - depth = Z cells
  - worldOffset/extraYRotation optional

If it provides storage capacity:
- Add ResourceStorageContainer
- Add ResourceStorageProvider
  - capacities[] for provided capacity
  - optionally enable grantStartingResources and fill startingResources[]

If it accepts resource dropoff from civilians:
- Add ResourceDropoff

If it produces units:
- Add Barracks
- Configure producibleUnits[]

If it is defensive:
- Add Turret and/or DefenseTurret
- Add UnitCombatController if required by your combat flow

Build catalog linkage:
- Create/assign a BuildItemDefinition asset
  - prefab
  - costs[]
  - buildTime
  - yOffset/placementOffset
  - category/aiPriority
- Add definition to BuildCatalog so it appears in BuildMenuUI.

-----------------------------------------------------------------
4) Construction Site Prefab
-----------------------------------------------------------------
ConstructionSite prefab requirements:
- ConstructionSite component (required)

Recommended:
- TeamVisual
- Building-like visuals/health indicator as needed

BuildPlacementManager settings:
- useConstructionSites = true
- constructionSitePrefab assigned
- reserveResourcesForSites as desired

-----------------------------------------------------------------
5) Unit Prefab Setup
-----------------------------------------------------------------
Combat unit minimum:
- Unit
- Attackable
- UnitCombatController
- NavMeshAgent
- Selectable

Civilian unit minimum:
- Civilian
- NavMeshAgent
- Selectable
- (Optional) CharacterStats for carry/harvest/build modifiers

If civilians should appear in task systems:
- Ensure JobManager exists in scene.

-----------------------------------------------------------------
6) Resource Node Prefab Setup
-----------------------------------------------------------------
Resource node minimum:
- ResourceNode
  - type
  - remaining
  - maxGatherers (limits simultaneous gather jobs)

Registry hookup:
- ResourceRegistry in scene (ResourceNode auto-registers OnEnable).

Gathering behavior notes:
- Civilians reserve gather slots on target nodes.
- When a node is full, civilians pick the next closest available node.

-----------------------------------------------------------------
7) Storage/Economy System Wiring
-----------------------------------------------------------------
Required scene components:
- TeamStorageManager
- TeamResources

Storage building wiring:
- ResourceStorageContainer handles actual per-building storage.
- ResourceStorageProvider adds/removes capacity and can optionally grant starting resources once.

Dropoff/pickup wiring:
- ResourceDropoff for valid deposit points.
- Civilians query nearest compatible storage via TeamStorageManager.


-----------------------------------------------------------------
7B) Production-chain Crafting Economy Setup
-----------------------------------------------------------------
Crafting building prefab minimum:
- CraftingBuilding (inherits Building)
- Define ProductionRecipe (inputs, outputs, craftTimeSeconds, batchSize, requiredJobType)
- Configure InputSlot + OutputSlot transforms
- Configure WorkPoints[] where workers physically stand to craft

Recommended crafting add-ons:
- ProductionStatusVisualizer (missing input / output full / no worker icons)
- ParticleSystem + AudioSource assigned in CraftingBuilding for production feedback

Worker specialization + assignment:
- Civilian now supports CivilianJobType (Generalist, Blacksmith, Carpenter, Farmer, Cook, Engineer)
- Recipe.requiredJobType gates who can operate the building
- Automatic assignment is handled by CraftingJobManager and building assignmentPriority
- Manual assignment can be performed through JobManager.AssignCivilianToCraftingBuilding(...)

Logistics workflow now expected:
1) Worker fetches required recipe input from nearest storage (cached storage lookup)

Crafting logistics rules (latest):
- Crafting stations should receive recipe inputs via direct deliveries from haulers/crafters, plus gatherers when the crafting station is their nearest valid dropoff for that carried resource.
- Crafted outputs should be hauled from the crafting station output queue to a different storage provider (do not route crafted output back into the station's own local container).
- Haulers should prioritize refilling crafting input buffers before resuming generic construction hauling.
- Crafting production can advance when assigned workers are occupying work points or standing within immediate working distance of the station/work points.
2) Worker delivers materials to building InputSlot
3) Worker moves to available WorkPoint and operates production
4) Outputs appear in building queue / OutputSlot
5) Worker carries crafted goods to nearest compatible storage

Throughput + expansion:
- Use maxWorkers, maxInputCapacityPerResource, maxOutputCapacityPerResource, craftingSpeedModifier
- Optional upgrades increase slots/speed/efficiency
- Recipes include forward-looking fields for power/fuel requirements and multi-tier chains

-----------------------------------------------------------------
8) Selection + Inspector System
-----------------------------------------------------------------
Selection flow:
- SelectionManager selects world objects.
- UnitInspectorUI receives selected object and renders contextual panels.

Demolish button behavior:
- Appears for Building selections (including child-click selections via parent lookup).
- Enabled for player-team buildings.

-----------------------------------------------------------------
9) Grid + Placement System
-----------------------------------------------------------------
Required scene scripts:
- BuildGridManager
- BuildPlacementManager
- BuildMenuUI (if player build UI is needed)

Placement rules currently supported:
- Multi-cell footprint checks via BuildingFootprint (width/depth).
- Rotation (R key) affects footprint orientation.
- Optional reservation blockers via BuildCellReservation.
- Optional construction-site workflow.

-----------------------------------------------------------------
10) Quick validation checklist
-----------------------------------------------------------------
Before pressing Play, verify:
[ ] Scene has all required managers.
[ ] At least one team bootstrap path exists.
[ ] HQ prefabs have Building + Headquarters and valid team IDs.
[ ] BuildPlacementManager has constructionSitePrefab assigned (if enabled).
[ ] Build catalog entries point to valid prefabs.
[ ] Buildable prefabs needing larger footprints have BuildingFootprint set.
[ ] Storage buildings have both ResourceStorageContainer and ResourceStorageProvider.
[ ] Crafting buildings have CraftingBuilding + ProductionRecipe + input/output/workpoint transforms configured.
[ ] CraftingJobManager + ProductionNotificationManager exist in scene for assignment/bottleneck alerts.
[ ] Resource nodes have ResourceNode with type/remaining/maxGatherers configured.
[ ] UI objects exist (SelectionManager, UnitInspectorUI, BuildMenuUI, EconomyUI).

-----------------------------------------------------------------
10B) Crafting Logistics Consistency Notes (latest)
-----------------------------------------------------------------

Crafting logistics consistency (latest)
- Crafting hauler assignments now preserve CivilianRole.Hauler when assigned to a CraftingBuilding.
  This is required so requireHaulerLogistics buildings continue executing fetch/deliver loops.
- On CraftingBuilding prefabs, keep exactly one ResourceStorageContainer in the prefab hierarchy.
  Multiple local storage containers can split inspector-visible storage from logistics targets.
- Avoid pairing ResourceDropoff with CraftingBuilding unless intentionally using mixed logistics.

-----------------------------------------------------------------
11) RTS Controls + Combat Modernization (new)
-----------------------------------------------------------------
Selection + input:
- SelectionManager now supports:
  - Left click single select
  - Left-drag selection rectangle for box select
  - Shift + click/drag to add or remove from selection
  - Hover highlighting through Selectable.SetHovered
- Right-click contextual commands:
  - Ground: Move order (formation offsets from UnitManager)
  - Enemy Attackable: Attack order via UnitCombatController.SetManualTarget
  - ResourceNode: Civilian gather order via Civilian.AssignPreferredNode
- Hold A + Right Click: Attack-move order for combat units.

Unit combat behavior:
- UnitCombatController now includes:
  - visionRange (separate from attack range)
  - stance-aware auto targeting (Hold / Guard / Aggressive)
  - behaviorState debug state
  - attack-move destination tracking
  - faster target refresh (targetRefreshSeconds)
- Attack and sight circles can be toggled with R for the primary selected combat unit.

Combat responsiveness + feedback:
- Projectile uses consistent MoveTowards travel and impactDistance.
- Attackable supports optional hit flash feedback (renderer color pulse).
- Unit nav agents receive varied avoidance priority to reduce clumping.

HQ diplomacy selection fix:
- UnitInspectorUI HQ diplomacy panel now resolves Headquarters using parent lookup,
  so clicking enemy HQ colliders reliably shows team and diplomacy controls.

Main menu expansion:
- MainMenuUI now includes "Match Setup (AoE Style)" with:
  - Team rows
  - Team color (RGB)
  - AI difficulty
  - Starting resources
  - Diplomacy stance (Ally/Neutral/Enemy)
- Setup can be applied to DiplomacyManager before game start.

-----------------------------------------------------------------
11) Civilian Needs + Housing Setup
-----------------------------------------------------------------
Civilian prefab additions (new survival system):
- Food tuning: hungerRatePerSecond, maxHunger, seekFoodThreshold01, foodToEatPerMeal, eatDurationSeconds, starvationDamagePerSecond
- Sleep tuning: tirednessRatePerSecond, maxTiredness, seekSleepThreshold01, sleepDurationSeconds, exhaustionDamagePerSecond
- Optional: assign a FoodResourceDatabase to drive food ranking/quality.

House building setup:
- Add House component (inherits Building)
- Configure prestige, comfort, storage, maxInhabitants
- Ensure teamID is assigned correctly at placement/spawn time

Behavior summary:
- Hungry civilians move to best available food storage.
- Tired civilians move to nearest valid house.
- If needs are ignored, civilians take survival damage.

Editor tooling:
- Use CubeWars/Tools/Resource Authoring to quickly create new ResourceNode prefabs.

-----------------------------------------------------------------
12) TeamBootstrap advanced spawn configuration (new)
-----------------------------------------------------------------
TeamBootstrap now supports per-team startup lists:
- civilianGroups[]: choose different civilian prefabs, counts, CivilianRole, and CivilianJobType.
- startingUnitGroups[]: choose multiple combat unit prefabs and counts.
- startingBuildings[]: choose building prefabs and exact grid coordinates/rotations for initial placement.

Starting building placement behavior:
- Uses BuildGridManager centered-footprint queries per team grid.
- Uses BuildingFootprint width/depth (rotation-aware).
- Rejects blocked/out-of-bounds/occupied cells.
- Marks every footprint cell occupied through BuildGridOccupant.

This means startup buildings now obey the same occupancy model as manual build placement.

Related docs:
- See Assets/Documentation/BuildingFootprint.txt for full prefab alignment rules.

UI behavior notes (latest)
- TaskBoardUI tab toggle now syncs with RTSGameSettings display flags.
- UnitInspectorUI includes Demolish Building action and expanded building stats (including Barracks/crafting/storage/stop-distance info).

-----------------------------------------------------------------
Storage/Crafting Logistics Fix Notes (Latest)
-----------------------------------------------------------------
- ResourceStorageProvider capacities are now applied only to the local ResourceStorageContainer on that building.
- This prevents crafting/storage buildings from exposing unrelated resource capacities just because other team storages exist.
- Building inspector storage should be treated as local-only: inspect per-building stored/capacity values, not team-global totals.
- Gatherers/haulers should only deposit to storages with free capacity for the carried resource type.
- If a target storage fills during transit, civilians should retarget another valid storage instead of dropping carried materials.
Reference
- Detailed crafting prefab walkthrough: Assets/Documentation/CraftingBuildingPrefabSetup.txt


-----------------------------------------------------------------
13) Per-resource storage send/receive controls (new)
-----------------------------------------------------------------
Resource storages now support per-resource hauling flow permissions.

Where to configure in Unity:
- On each `ResourceStorageContainer` component.
- Inspector displays one row per ResourceType:
  `<Resource> Flow (Hauler Pickup/Dropoff)`.

Flow mode meaning:
- Disabled: no hauling in or out for that resource.
- ReceiveOnly: haulers can drop off only.
- SupplyOnly: haulers can pick up only.
- ReceiveAndSupply: both directions allowed.

Behavior impact:
- TeamStorageManager nearest-storage queries now filter by flow mode:
  - pickup requests only consider `SupplyOnly` / `ReceiveAndSupply`.
  - drop-off requests only consider `ReceiveOnly` / `ReceiveAndSupply`.
- Crafting output delivery also respects target storage `CanReceive` flow settings.
- UnitInspectorUI storage panel now displays flow state per resource at runtime.

Prefab setup reminder:
- For each crafting building, verify every relevant storage resource row is configured intentionally (not left ambiguous).
- Keep exactly one ResourceStorageContainer per crafting building hierarchy.


- Simplified crafting workflow baseline:
  - Haulers are responsible for logistics only (deliver recipe inputs to crafting buildings, then remove outputs).
  - Assigned crafters/non-haulers should stand near workPoints to enable production and should not run logistics loops.
  - Input resources should only be delivered into crafting building input buffers.
  - Output resources should only be taken away from crafting building output queues.
