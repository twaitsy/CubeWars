CubeWars Crafting Building Prefab Setup
======================================

Purpose
- Step-by-step checklist for creating a new crafting building prefab and wiring it into gameplay.
- Use this when adding a station like a forge, workshop, kitchen, or refinery.

------------------------------------------------------------
1) Create the prefab root
------------------------------------------------------------
1. Create a new GameObject in scene (example name: "Forge").
2. Add base visual mesh and collider(s).
3. Make sure at least one collider is present for selection and placement checks.
4. Drag it into `Assets/Prefabs/Buildings/` to create the prefab.

Required root components:
- CraftingBuilding
- (Inherited) Building fields on CraftingBuilding must be configured

Recommended root components:
- TeamVisual
- BuildingInteractionSettings
- BuildingPrefabValidator
- ResourceStorageContainer (for local input/output storage)
- ResourceStorageProvider (if this building should add team storage capacity)

Important hierarchy rule:
- Keep exactly one ResourceStorageContainer in the prefab hierarchy.

------------------------------------------------------------
2) Configure CraftingBuilding
------------------------------------------------------------
Set these fields on `CraftingBuilding`:
- `recipe` (ProductionRecipe asset)
- `inputSlot` (Transform where input handoff is visualized)
- `outputSlot` (Transform where output is visualized)
- `InteractionPoint` children with `pointType=CraftWork` (where workers stand while crafting)
- Throughput/capacity fields used by your current crafting flow
- `requireHaulerLogistics` should be enabled for the simplified logistics workflow
  (haulers deliver inputs and evacuate outputs; workers stay at workPoints)

Production feedback (recommended):
- Assign optional particle and audio references on CraftingBuilding.
- Add ProductionStatusVisualizer for missing input/full output/no worker indicators.

------------------------------------------------------------
3) Create and assign a ProductionRecipe
------------------------------------------------------------
Create a ProductionRecipe asset and set:
- `inputs` (resource type + amount)
- `outputs` (resource type + amount)
- `craftTimeSeconds`
- `batchSize`
- `requiredJobType` (must match an available CivilianJobType)

Job type alignment:
- Ensure at least one civilian role can satisfy `requiredJobType`
  (Blacksmith, Carpenter, Farmer, Cook, Engineer, etc.).

------------------------------------------------------------
4) Add build menu/catalog entry
------------------------------------------------------------
Create or update a BuildItemDefinition asset:
- `prefab` = your crafting building prefab
- `costs[]`
- `buildTime`
- `yOffset` / `placementOffset`
- category/priority values as needed

Then add this definition to `BuildingsDatabase` so it appears in BuildMenuUI (asset location: `Assets/Data/Databases/BuildingsDatabase.asset`).

------------------------------------------------------------
5) Scene setup requirements
------------------------------------------------------------
The active scene should include:
- TeamStorageManager
- TeamResources
- BuildPlacementManager
- BuildGridManager
- ResourceRegistry
- JobManager
- CraftingJobManager
- ProductionNotificationManager

When using logistics-heavy setups also ensure:
- reachable storage exists with free capacity for crafted resource types
- at least one hauler civilian is available if hauler logistics is required

------------------------------------------------------------
6) Validation checklist before playtest
------------------------------------------------------------
- Prefab places correctly with expected footprint/alignment.
- Building can be selected and inspected.
- Inputs are delivered to the building by haulers before output pickup begins.
- A correctly skilled non-hauler worker reaches a work point and remains in operating range while production runs.
- Outputs are produced in-building first, then moved to external storage by haulers only after input demand is satisfied.
- No input resources are hauled out of the building output slot, and no output resources are dropped into input slot logic.
- No validator warnings for missing/conflicting production components.

Quick troubleshooting
- "No crafting starts": check recipe assignment, requiredJobType, and worker availability.
- "Inputs never arrive": verify storage capacity and logistics roles/pathing.
- "Output jam": ensure output destination storage has free capacity.
- "Placement weird": verify footprint size, collider bounds, and offsets.

------------------------------------------------------------
7) Configure storage flow permissions (send/receive/both)
------------------------------------------------------------
Each crafting/storage building should expose one `ResourceStorageContainer` and configure per-resource hauling flow.

In Unity Inspector (ResourceStorageContainer):
- Each resource now appears as: `<Resource> Flow (Hauler Pickup/Dropoff)`.
- Valid modes:
  - `Disabled` = no hauling for that resource.
  - `ReceiveOnly` = can only accept drop-offs.
  - `SupplyOnly` = can only be picked up from.
  - `ReceiveAndSupply` = both drop-off and pickup allowed.

Recommended crafting defaults:
- Raw inputs (ore/logs/food inputs): set source storages to `SupplyOnly` or `ReceiveAndSupply`.
- Crafting output destinations: set to `ReceiveOnly` or `ReceiveAndSupply`.
- Block accidental loops by setting non-target storages to `Disabled` when needed.

Runtime inspector visibility:
- UnitInspectorUI now shows local storage lines in this format:
  `<Resource> Storage â€” <stored>/<capacity> | Flow: <mode>`.
- Use this to verify send/receive behavior in play mode while selecting buildings.


Latest notes
- Crafting input request generation now asks for full missing amount per resource (haulers still limited by their own carry capacity at withdrawal).
- UnitInspectorUI Storage tab now shows per-recipe input-buffer and output-queue totals when selecting crafting buildings.


Latest recipe-output restriction
- Assign `resourcesDatabase` on CraftingBuilding.
- Only recipe outputs categorized as `Refined` are produced/queued/picked up.
- Non-Refined recipe outputs are ignored at runtime with a warning.


Update (2026-02):
- Crafting stations can define multiple craft stations using InteractionPoint components with pointType=CraftWork.
- Craft worker positioning is now fully InteractionPoint-driven (CraftWork).
- Job/task queuing now respects workstation count (one queued crafting job per available work point).

- RequireComponent on CraftingBuilding now enforces a root ResourceStorageContainer.


Update (2026-02-20)
- Legacy Farm.cs production path removed. CraftingBuilding is the only supported production script for prefab setup in this guide.
- `maxWorkers` represents production workers at work points; `maxAssignedHaulers` now drives separate hauler-task queueing and assignment caps.
- Require at least one valid unit definition in UnitsDatabase for each spawned worker/combat prefab, configured via inspector unitDefinitionId dropdowns.


Update (2026-02-20)
- Remove legacy reliance on `workPoints[]` for production worker positioning.
- Author one or more `InteractionPoint` child markers with `pointType=CraftWork` for production workers.
- Keep using `CraftInput` and `CraftOutput` interaction points for logistics pathing when `inputSlot`/`outputSlot` are not explicitly assigned.
- Crafting task generation now follows CraftingRegistry state changes; ensure the building can emit real state transitions (inputs missing, inputs ready, in progress, output ready, waiting pickup).
